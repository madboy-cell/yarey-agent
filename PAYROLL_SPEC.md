# Payroll & Finance Module Specification
**Target Phase:** Phase 5 (Owner's Command)
**Status:** DRAFT

## 1. Objective
To automate the calculation of month-end staff payouts, ensuring accuracy in commissions and providing clear financial visibility for the business owner.

## 2. Core Logic vs. Current State
*   **Current State:** Bookings track a `salesmanId` and a calculated `commissionAmount`.
*   **Gap:** We currently calculate commission *per booking*. We need to aggregate this *per staff member per month* and add base salaries/deductions.

## 3. Implementation Steps

### Step 1: Enhanced Staff Profile (Data Layer)
We need to upgrade the `Salesman` entity to a full `Staff` profile.
*   **New Fields:**
    *   `baseSalary` (Number): Fixed monthly income.
    *   `role` (Enum): `Manager`, `Sales`, `Therapist`.
    *   `bankDetails` (String): For reference.

### Step 2: The Payroll Engine (Logic Layer)
A utility function `calculatePayroll(month, year)` that:
1.  Fetches all `bookings` where `status` is **Completed/Paid**.
2.  Groups commission amounts by `salesmanId`.
3.  Calculates **Total Sales Revenue** generated by that staff.
4.  Adds `baseSalary`.
5.  Returns a `PayrollReport` object.

### Step 3: The Owner's Dashboard (UI Layer)
A new secured tab `/admin/finance`.

#### 3.1 Financial Overview
*   **Net Profit Estimate:** (Total Revenue) - (Total Commission + Total Base Salaries + Est. COGS).
*   **Payout Ratio:** What % of revenue is going to staff?

#### 3.2 Staff Payroll Table
| Staff Name | Base Salary | Sales Comm. | Service Comm. (Future) | **Total Payout** | Actions |
| :--- | :--- | :--- | :--- | :--- | :--- |
| **Alice** | ฿15,000 | ฿4,500 | - | **฿19,500** | [Print Slip] |
| **Bob** | ฿12,000 | ฿8,200 | - | **฿20,200** | [Print Slip] |

#### 3.3 Payslip Generation
*   Use `jspdf` to generate a branded PDF PDF containing:
    *   Breakdown of all earnings.
    *   List of specific high-value sales (audit trail).
    *   Signature line for staff acknowledgement.

## 4. Technical Requirements
*   **Security:** This view contains sensitive salary data.
    *   *Intermediate Solution:* Simple "Owner PIN" (e.g., 4-digit code) stored in LocalStorage/Firebase to unlock this tab.
*   **Persistence:**
    *   We don't need to save the *calculations* (they can be re-run), but we should save the **Status** of a month (e.g., "January 2026: PAID").
    *   New Collection: `yarey_payroll_runs`.

## 5. Next Action
Shall we build the **Staff Profile Upgrades** (Step 1) or the **Calculation Logic** (Step 2) first?
